version: '{branch}-{build}'

skip_tags: true

environment:
  CL: /MP
  generator: Visual Studio 16 2019
  ifw_location: C:\Qt\Tools\QtInstallerFramework\4.3
  iric_access_token:
    secure: kGB7+cEG4P/hpRudE+trZHlt2y8CMBhEznGPb3nvH3HiGFRxXOiu/mBKKftEMhU/Kirhlvo+9yHD9Hj1nnXrJQ4Jq5SmQh0s6K+Qg2RqZ7CVufCbvvx6+VoIobvlWS9y
  kskinoue0612_access_token:
    secure: todo
  scharlton2_access_token:
    secure: xawcr/f1HW+2ad233K03DxKOOgTL6iP7uxITt/PdJdrd5hrGbYrUM1EmG5pItnle
  iric_json_pw:
    secure: x7Bi2kbDreMKpnkY3Y8a1A==
  kskinoue0612_json_pw:
    secure: todo
  scharlton2_json_pw:
    secure: 8B/dWokM+gmQ77IN22zETQ==


image:
  - Visual Studio 2019

init:
  - ps: |
      if ($env:iric_json_pw) { echo "iric_json_pw = $($env:iric_json_pw.Length)" }
      if ($env:scharlton2_json_pw) { echo "scharlton2_json_pw = $($env:scharlton2_json_pw.Length)" }
  - pwsh: |
      if ($env:iric_json_pw) { echo "iric_json_pw = $($env:iric_json_pw.Length)" }
      if ($env:scharlton2_json_pw) { echo "scharlton2_json_pw = $($env:scharlton2_json_pw.Length)" }

configuration:
  - Debug
  - Release

matrix:
  fast_finish: true

before_build:
  - pwsh: |
      ####################################################################################
      # *_json_pw env vars contain encrypted password
      ####################################################################################
      $pw = $env:iric_json_pw
      if ($env:APPVEYOR_REPO_NAME -eq "scharlton2/av_ticket") {
        $pw = $env:scharlton2_json_pw
      }
      if ($env:APPVEYOR_REPO_NAME -eq "kskinoue0612/av_ticket") {
        $pw = $env:kskinoue0612_json_pw
      }
      7z x -p"$($pw*10)" appveyor.json.7z
      Write-Output "Should be CFC51A12FF707A076DC011AFD7DD65A5626708930D4AB4B532F0B7F69AA2D3E6"
      Get-FileHash appveyor.json

build_script:
  - ps: |
      if ($env:Configuration -eq "Debug") {
        $env:artifact="debug.appveyor.json.7z"
        Rename-Item appveyor.json.7z debug.appveyor.json.7z
      }
      if ($env:Configuration -eq "Release") {
        $env:artifact="release.appveyor.json.7z"
        Rename-Item appveyor.json.7z release.appveyor.json.7z
      }
  - echo "Finished"

artifacts:
  - path: $(artifact)

before_deploy:
  - pwsh: |
      if ($true) {
        [System.Environment]::SetEnvironmentVariable('release_title', "iricdev $(get-date -AsUTC -Format o)", 'Machine')
      }
  - ps: $env:release_title=[System.Environment]::GetEnvironmentVariable('release_title', 'Machine')
  - ps: $env:token=$env:scharlton2_access_token

deploy:
  - provider: GitHub
    tag: LATEST
    release: $(release_title)
    description: 'Test release'
    auth_token: $(token)
    artifact: $(artifact)
    draft: false
    prerelease: false
    force_update: true
    on:
      branch: gh_release             # release from gh_release branch only
      APPVEYOR_REPO_TAG: false       # deploy on tag push only
